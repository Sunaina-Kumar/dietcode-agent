name: DietCode - Diagnose CI Failures

on:
  workflow_run:
    workflows: ["*"]
    types: [completed]

jobs:
  diagnose-failure:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      checks: read
    
    steps:
      - name: Checkout DietCode Agent
        uses: actions/checkout@v4
        with:
          repository: YOUR_USERNAME/dietcode-agent
          path: dietcode-agent
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install MCP Servers
        run: |
          npm install -g @modelcontextprotocol/server-github
          npm install -g @modelcontextprotocol/server-filesystem
      
      - name: Install Python Dependencies
        working-directory: dietcode-agent
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Get PR Number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
              state: 'open'
            });
            
            if (prs.length > 0) {
              return prs[0].number;
            }
            return null;
      
      - name: Run DietCode Diagnosis
        if: steps.pr.outputs.result != 'null'
        working-directory: dietcode-agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-4-turbo-preview
          MCP_CONFIG_PATH: ./config/mcp_config.json
        run: |
          python -m src.main \
            ${{ github.repository_owner }} \
            ${{ github.event.repository.name }} \
            ${{ steps.pr.outputs.result }}